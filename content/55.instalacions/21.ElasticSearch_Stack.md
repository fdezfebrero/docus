# ElasticSearch Stack

## Instalacion de Elasticsearch y Kibana con docker

*Las versiones de los servicios deben ser todas las mismas, en este caso se usa la 8.1.2

### Elasticsearch

Crear una red para que puedan comunicarse
```bash
docker network create elastic
```
Crear volumenes para persistir los datos, del nodo principal, del secundario y de kibana
```bash
docker volume create el01-data
docker volume create el02-data
docker volume create kib01-data
```
Descargar imagen de ELK
```bash
docker pull docker.elastic.co/elasticsearch/elasticsearch:8.1.2
```
Levantar los contenedores de elastic search
Con el tag -m establecemos un limite de la memoria que puede consumir nuestra aplicacion en procesos. Para evitar errores y sobrecargas del sistema
```bash
docker run --name es01 --net elastic -v es01-data:/usr/share/elasticsearch/data -p 9200:9200 -it -m 1GB docker.elastic.co/elasticsearch/elasticsearch:8.1.2
```

Copiamos el certificado en la maquina local
```bash
docker cp es01:/usr/share/elasticsearch/config/certs/http_ca.crt .
```

Regenrar password elasticsearch
```bash
docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
```

### Kibana
Descargar imagen de Kibana
```bash
docker pull docker.elastic.co/kibana/kibana:8.1.2
```

Levantar los contenedores de kibana
Con el tag -m establecemos un limite de la memoria que puede consumir nuestra aplicacion en procesos. Para evitar errores y sobrecargas del sistema
```bash
docker run --name kib01 --net elastic -v es01-data:/usr/share/kibana/data -p 5601:5601 docker.elastic.co/kibana/kibana::8.1.2
```

Para completar el procesos hay que seguir la url que devuelve el contenedor y a単adir la token key que proporciona Elastic con el siguiente comando
```bash
docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
```

### A単adir nodos

Obtenemos el TOKEN para a単adir nodes del nodo principal, Ese token lo tenemos que a単adir al levantar el segundo nodo como variable de entorno
```bash
docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s node
```

Levantar los contenedores de kibana
Con el tag -m establecemos un limite de la memoria que puede consumir nuestra aplicacion en procesos. Para evitar errores y sobrecargas del sistema
```bash
docker run -e ENROLLMENT_TOKEN="<token>" --name es02 --net elastic -v es02-data:/usr/share/elasticsearch/data -it -m 1GB docker.elastic.co/elasticsearch/elasticsearch:8.1.2
```
